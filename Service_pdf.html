<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KINYA Service Report</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@400;500;600;700&display=swap');
    
    @media print {
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        background: white;
        font-size: 11px;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        color-adjust: exact;
      }
      .no-print {
        display: none !important;
      }
      .header, .doc-no, .title, table, .section-header, .footer {
        page-break-inside: avoid;
      }
      .container {
        box-shadow: none;
        padding: 0;
        margin: 0;
        max-width: 100%;
        border-radius: 0;
        border: 2.5px  solid #000 !important; /* Added four-side border */
      }
      .logo-watermark, .stamp-area {
        display: none !important;
      }
      table {
        box-shadow: none;
        border: 1.5px solid #000 !important;
      }
      th, td {
        border: 1.5px solid #000 !important;
        padding: 5px !important; /* Reduced padding for print */
      }
      .data-field {
        color: #000 !important;
        font-weight: 700 !important;
      }
      .title {
        background: #004B9B !important;
        color: white !important;
        -webkit-print-color-adjust: exact;
        padding: 8px !important; /* Reduced padding */
        margin: 10px 0 12px !important; /* Reduced margins */
      }
      th {
        background-color: #e0e0e0 !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        padding: 5px !important; /* Reduced padding */
      }
      .section-header {
        background: #e0e0e0 !important;
        color: #000 !important;
        border: 1.5px solid #000 !important;
        -webkit-print-color-adjust: exact;
        padding: 7px !important; /* Reduced padding */
        margin: 10px 0 8px !important; /* Reduced margins */
      }
      .feedback-table tr:nth-child(1) td:nth-child(1), 
      .feedback-table tr:nth-child(1) td:nth-child(2) { 
        background-color: #d0e8d0 !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
      }
      .feedback-table tr:nth-child(1) td:nth-child(3),
      .feedback-table tr:nth-child(1) td:nth-child(4) { 
        background-color: #f8d0d0 !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
      }
      .header {
        margin-bottom: 10px !important; /* Reduced margin */
        padding-bottom: 10px !important; /* Reduced padding */
      }
      .footer {
        margin-top: 15px !important; /* Reduced margin */
        padding-top: 10px !important; /* Reduced padding */
      }
      .compact-row {
        margin-bottom: 3px !important; /* Reduced margin */
      }
      .signature-line {
        margin-top: 20px !important; /* Reduced margin */
      }
      .spares-table td, .spares-table th {
        padding: 3px !important; /* Reduced padding */
      }
    }
    
    @page {
      size: A4;
      margin: 8mm; /* Reduced margin for more space */
    }
    
    body {
      font-family: 'Roboto', Arial, sans-serif;
      font-size: 12px;
      margin: 0;
      padding: 15px;
      color: #222;
      width: 100%;
      box-sizing: border-box;
      background-color: #f5f7fa;
    }

    .container {
      background: white;
      padding: 15px; /* Reduced padding */
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
      max-width: 800px;
      margin: 0 auto;
      border-radius: 6px;
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, #004B9B, #2D7DD2, #004B9B);
    }

    .button-container {
      text-align: center;
      margin-bottom: 15px; /* Reduced margin */
    }
    
    .print-button {
      background: #004B9B;
      color: white;
      border: none;
      padding: 8px 16px; /* Reduced padding */
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin: 0 8px;
      transition: all 0.3s;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0,75,155,0.2);
    }
    
    .print-button:hover {
      background: #003366;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,75,155,0.3);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px; /* Reduced margin */
      border-bottom: 2px solid #004B9B;
      padding-bottom: 12px; /* Reduced padding */
      position: relative;
    }

    .left-info {
      line-height: 1.3;
      flex: 1;
    }

    .right-info {
      text-align: right;
      line-height: 1.3;
      flex: 1;
    }

    h2 {
      color: #004B9B;
      margin: 0 0 3px 0;
      font-size: 22px;
      font-family: 'Montserrat', sans-serif;
      font-weight: 800;
      letter-spacing: 0.5px;
    }

    .sub-header {
      margin-top: 0;
      font-weight: 700;
      font-size: 12px;
      color: #2D7DD2;
    }

    .tagline {
      font-style: italic;
      color: #555;
      margin-top: 2px;
      margin-bottom: 6px; /* Reduced margin */
      font-size: 11px;
    }

    .doc-no {
      text-align: right;
      font-weight: 700;
      margin-top: -18px; /* Adjusted margin */
      margin-bottom: 8px; /* Reduced margin */
      font-size: 11px;
      color: #444;
      padding: 3px 8px;
      background: #f0f5ff;
      display: inline-block;
      float: right;
      border-radius: 3px;
    }

    .title {
      text-align: center;
      font-weight: 800;
      background: linear-gradient(to right, #004B9B, #2D7DD2);
      color: white;
      padding: 8px;
      border: none;
      margin: 12px 0 12px; /* Reduced margins */
      font-size: 15px;
      border-radius: 4px;
      font-family: 'Montserrat', sans-serif;
      letter-spacing: 0.5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      table-layout: fixed;
      border: 1.5px solid #333;
    }

    td, th {
      border: 1.5px solid #333;
      padding: 6px;
      vertical-align: top;
      word-wrap: break-word;
    }

    tr:nth-child(even) {
      background-color: #f8f8f8;
    }

    th {
      background-color: #e6f0ff;
      font-weight: 700;
      color: #003366;
      font-size: 11px;
    }

    .section-header {
      font-weight: 700;
      font-size: 12px;
      background: linear-gradient(to right, #e6f0ff, #d9e6ff);
      padding: 8px;
      border: 1.5px solid #333;
      margin-top: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      color: #003366;
      font-family: 'Montserrat', sans-serif;
    }

    .feedback-table td {
      text-align: center;
      padding: 6px;
      font-weight: 600;
      font-size: 11px;
    }

    .feedback-table tr:nth-child(1) td:nth-child(1) { background-color: #e8f5e9; color: #1b5e20; }
    .feedback-table tr:nth-child(1) td:nth-child(2) { background-color: #e8f5e9; color: #1b5e20; }
    .feedback-table tr:nth-child(1) td:nth-child(3) { background-color: #ffebee; color: #b71c1c; }
    .feedback-table tr:nth-child(1) td:nth-child(4) { background-color: #ffebee; color: #b71c1c; }

    .footer {
      text-align: center;
      font-weight: 700;
      margin-top: 20px;
      font-size: 12px;
      border-top: 2px solid #004B9B;
      padding-top: 12px;
      color: #004B9B;
    }

    .footer-address {
      font-size: 11px;
      margin-top: 4px; /* Reduced margin */
      color: #555;
      line-height: 1.4;
    }
    
    .spares-table {
      font-size: 11px;
    }
    
    .spares-table td, .spares-table th {
      padding: 4px;
    }
    
    .text-center {
      text-align: center;
    }
    
    .text-right {
      text-align: right;
    }
    
    .mb-5 {
      margin-bottom: 5px;
    }
    
    .mt-10 {
      margin-top: 10px;
    }
    
    .signature-line {
      border-top: 2px solid #333;
      width: 120px;
      display: inline-block;
      margin-top: 30px;
    }
    
    .data-field {
      font-weight: 700;
      color: #004B9B;
    }
    
    .info-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      background: #e6f0ff;
      color: #003366;
      font-size: 10px;
      margin-right: 4px;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .logo-watermark {
      position: absolute;
      opacity: 0.03;
      font-size: 140px;
      font-weight: 900;
      color: #004B9B;
      font-family: 'Montserrat', sans-serif;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      z-index: -1;
      user-select: none;
      pointer-events: none;
    }
    
    .stamp-area {
      position: absolute;
      right: 25px;
      bottom: 100px;
      opacity: 0.8;
      transform: rotate(15deg);
    }
    
    .stamp {
      border: 2px solid #c62828;
      color: #c62828;
      padding: 6px 10px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 12px;
      text-align: center;
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      box-shadow: 0 0 8px rgba(198,40,40,0.3);
    }

    .compact-row {
      margin-bottom: 4px; /* Reduced margin */
    }
    
    strong {
      color: #222;
    }
    
    /* New class to reduce spacing for one-page printing */
    .compact-view {
      line-height: 1.2;
    }
    
    /* Force content to fit on one page */
    .force-one-page {
      height: 1123px; /* A4 height in pixels at 96dpi */
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div class="container force-one-page">
    <div class="logo-watermark">KINYA</div>
    
    <div class="button-container no-print">
      <button class="print-button" onclick="window.print()">
        <i class="fas fa-print"></i> Print Report
      </button>
      <button class="print-button" onclick="generatePDF()">
        <i class="fas fa-download"></i> Download PDF
      </button>
    </div>
  
    <div id="pdf-content" class="compact-view">
      <div class="header">
        <div class="left-info">
          <h2>KINYA</h2>
          <div class="sub-header">MEDICAL SYSTEMS AND SOLUTIONS</div>
          <div class="tagline">Your Vision, Our Mission</div>
          <div class="compact-row"><span class="info-badge"><i class="fas fa-phone"></i> Phone:</span> +91 9789041308</div>
          <div class="compact-row"><span class="info-badge"><i class="fas fa-envelope"></i> Email:</span> sales@kinya.in</div>
          <div class="compact-row"><span class="info-badge"><i class="fas fa-globe"></i> Web:</span> www.kinya.in</div>
        </div>
        <div class="right-info">
          <div class="compact-row"><span class="info-badge"><i class="fas fa-file-invoice"></i> GSTIN No.:</span> 33AAOFK8368D1Z2</div>
          <div class="compact-row"><span class="info-badge"><i class="fas fa-id-card"></i> PAN No.:</span> AAOFK8368D</div>
          <div class="compact-row"><span class="info-badge"><i class="fas fa-pills"></i> DRUG LICENSE No.:</span> TN-06-21B-00180, TN-06-20B-00180</div>
        </div>
      </div>

      <div class="doc-no">DOC NO: KMSS/QSP/40 Rev- 02</div>

      <div class="title">SERVICE REPORT</div>

      <table>
        <tr>
          <td width="50%"><strong><i class="fas fa-hashtag"></i> CSR No. :</strong> <span id="pdf-csrNo" class="data-field"></span></td>
          <td width="50%"><strong><i class="fas fa-calendar"></i> DATE :</strong> <span id="pdf-date" class="data-field"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-building"></i> Customer Name :</strong> <span id="pdf-customerName" class="data-field"></span></td>
          <td><strong><i class="fas fa-tools"></i> Equipment name :</strong> <span id="pdf-equipmentName" class="data-field"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-map-marker-alt"></i> Address :</strong> <span id="pdf-address" class="data-field"></span></td>
          <td><strong><i class="fas fa-barcode"></i> S.N :</strong> <span id="pdf-serialNo" class="data-field"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-city"></i> City :</strong> <span id="pdf-city" class="data-field"></span></td>
          <td><strong><i class="fas fa-industry"></i> Manufacturer :</strong> <span id="pdf-manufacturer" class="data-field"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-phone"></i> Contact :</strong> <span id="pdf-contactNo" class="data-field"></span></td>
          <td><strong><i class="fas fa-laptop-code"></i> Model:</strong> <span id="pdf-model" class="data-field"></span></td>
        </tr>
      </table>

      <div class="section-header">
        <i class="fas fa-clipboard-list"></i> PROBLEM REPORTED/SERVICE DETAILS – PPM, EMERGENCY CALL, REGULAR MAINTENANCE, INSTALLATION
      </div>

      <table>
        <tr>
          <td><strong><i class="fas fa-exclamation-circle"></i> Problem reported :</strong><br><span id="pdf-customerProblem" style="white-space: pre-line;"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-wrench"></i> Service Rendered :</strong><br><span id="pdf-rectification" style="white-space: pre-line;"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-search"></i> Defects found on inspection :</strong><br><span id="pdf-diagnosisFindings" style="white-space: pre-line;"></span></td>
        </tr>
      </table>

      <div class="mb-5"><strong><i class="fas fa-cogs"></i> Spares replaced :</strong></div>
      <table class="spares-table">
        <tr>
          <th width="60%">Spare Part</th>
          <th width="20%" class="text-center">Quantity</th>
          <th width="20%" class="text-right">Cost (₹)</th>
        </tr>
        <tbody id="pdf-spares">
          <!-- Spares will be populated here -->
        </tbody>
      </table>

      <table>
        <tr>
          <td width="33%"><strong><i class="fas fa-calendar-day"></i> Events Date :</strong><br><span id="pdf-events" class="data-field"></span></td>
          <td width="33%"><strong><i class="fas fa-play-circle"></i> Start of Service :</strong><br><span id="pdf-startOfService" class="data-field"></span></td>
          <td width="34%"><strong><i class="fas fa-stop-circle"></i> End of Service :</strong><br><span id="pdf-endOfService" class="data-field"></span></td>
        </tr>
      </table>

      <div class="mt-10"><strong><i class="fas fa-comment-dots"></i> CUSTOMER FEEDBACK</strong></div>
      <table class="feedback-table">
        <tr>
          <td width="25%"><i class="fas fa-smile"></i> Extremely Satisfied</td>
          <td width="25%"><i class="fas fa-smile"></i> Satisfied</td>
          <td width="25%"><i class="fas fa-frown"></i> Dissatisfied</td>
          <td width="25%"><i class="fas fa-angry"></i> Annoyed</td>
        </tr>
      </table>

      <table>
        <tr>
          <td><strong><i class="fas fa-sticky-note"></i> Remarks:</strong><br><span id="pdf-remarks" style="white-space: pre-line;"></span></td>
        </tr>
      </table>

      <table>
        <tr>
          <td width="33%"><strong><i class="fas fa-user"></i> Name :</strong> <span id="pdf-engineerName" class="data-field"></span></td>
          <td width="33%"><strong><i class="fas fa-briefcase"></i> Designation :</strong> Service Engineer</td>
          <td width="34%"><strong><i class="fas fa-phone"></i> Phone/Fax :</strong> <span id="pdf-engineerContact" class="data-field"></span></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-envelope"></i> Email :</strong> <span id="pdf-engineerEmail" class="data-field"></span></td>
          <td colspan="2"></td>
        </tr>
        <tr>
          <td><strong><i class="fas fa-signature"></i> Signature :</strong> <div class="signature-line"></div></td>
          <td><strong><i class="fas fa-calendar"></i> Date :</strong> <span id="pdf-closedDate" class="data-field"></span></td>
          <td><strong><i class="fas fa-map-pin"></i> Place :</strong> <span id="pdf-customerCity" class="data-field"></span></td>
        </tr>
      </table>

      <div class="stamp-area no-print">
        <div class="stamp">SERVICE COMPLETED<br>KINYA</div>
      </div>

      <div class="footer">
        Thank you, for doing business with us
        <div class="footer-address">
          <i class="fas fa-map-marker-alt"></i> Address: Plot No. 55, Mahalakshmi Nagar Ext-7, Nandivaram, Guduvanchery, Chengalpattu Taluk,<br>
          Kanchipuram District, Chennai – 603202, Tamil Nadu.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  
  <script>
    // Function to get URL parameters
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // Function to load report data
    async function loadReportData() {
      const reportId = getQueryParam('id');
      
      if (!reportId) {
        alert('No report ID provided');
        return;
      }

      try {
        // Fetch report data from SheetDB
        const response = await fetch(`https://sheetdb.io/api/v1/h1rkfluwzhx6l/search?id=${reportId}`);
        const data = await response.json();
        
        if (data.length === 0) {
          alert('Report not found');
          return;
        }

        const report = data[0];
        
        // Populate the PDF template with report data
        document.getElementById('pdf-csrNo').textContent = report.csrNo || 'N/A';
        document.getElementById('pdf-date').textContent = report.date || 'N/A';
        document.getElementById('pdf-customerName').textContent = report.customerName || 'N/A';
        document.getElementById('pdf-equipmentName').textContent = report.equipmentName || 'N/A';
        document.getElementById('pdf-address').textContent = report.address || 'N/A';
        document.getElementById('pdf-serialNo').textContent = report.serialNo || 'N/A';
        document.getElementById('pdf-city').textContent = report.city || 'N/A';
        document.getElementById('pdf-customerCity').textContent = report.city || 'N/A';
        document.getElementById('pdf-manufacturer').textContent = report.manufacturer || 'N/A';
        document.getElementById('pdf-contactNo').textContent = report.contactNo || 'N/A';
        document.getElementById('pdf-model').textContent = report.model || 'N/A';
        document.getElementById('pdf-customerProblem').textContent = report.customerProblem || 'N/A';
        document.getElementById('pdf-rectification').textContent = report.rectification || 'N/A';
        document.getElementById('pdf-diagnosisFindings').textContent = report.diagnosisFindings || 'N/A';
        document.getElementById('pdf-events').textContent = report.events || 'N/A';
        document.getElementById('pdf-startOfService').textContent = report.startOfService || 'N/A';
        document.getElementById('pdf-endOfService').textContent = report.endOfService || 'N/A';
        document.getElementById('pdf-engineerName').textContent = report.engineerName || 'N/A';
        document.getElementById('pdf-closedDate').textContent = report.closedDate || 'N/A';
        
        // Default engineer contact info
        document.getElementById('pdf-engineerContact').textContent = '+91 9789041308';
        document.getElementById('pdf-engineerEmail').textContent = 'service@kinya.in';
        
        // Handle spares data
        const sparesTable = document.getElementById('pdf-spares');
        sparesTable.innerHTML = '';
        
        if (report.spareNames && report.spareNames !== 'N/A') {
          const spareNames = report.spareNames.split(', ');
          const spareQuantities = report.spareQuantities.split(', ');
          const spareCosts = report.spareCosts.split(', ');
          
          for (let i = 0; i < spareNames.length; i++) {
            if (spareNames[i] && spareNames[i].trim() !== '') {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${spareNames[i] || 'N/A'}</td>
                <td class="text-center">${spareQuantities[i] || 'N/A'}</td>
                <td class="text-right">${spareCosts[i] ? '₹' + spareCosts[i] : 'N/A'}</td>
              `;
              sparesTable.appendChild(row);
            }
          }
        }
        
        // Add empty rows if no spares
        if (sparesTable.children.length === 0) {
          for (let i = 0; i < 2; i++) {
            const row = document.createElement('tr');
            row.innerHTML = '<td></td><td class="text-center"></td><td class="text-right"></td>';
            sparesTable.appendChild(row);
          }
        }
      } catch (error) {
        console.error('Error loading report:', error);
        alert('Error loading report data');
      }
    }
    
    // Function to generate PDF
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      
      const element = document.getElementById('pdf-content');
      
      html2canvas(element, {
        scale: 2,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190; // A4 width in mm (with margins)
        const pageHeight = 277; // A4 height in mm (with margins)
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10;
        
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add more pages if needed
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight + 10;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        // Save the PDF
        const fileName = `Service_Report_${document.getElementById('pdf-csrNo').textContent}.pdf`;
        pdf.save(fileName);
      });
    }
    
    // Load report data when page loads
    window.onload = loadReportData;
  </script>
</body>
</html>